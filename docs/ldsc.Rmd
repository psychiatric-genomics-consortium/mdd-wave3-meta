---
title: LD Score Genetic Correlations
output:
  github_document
---

```{r}
library(readr)
library(dplyr)
library(stringr)
library(tidyr)
library(ggplot2)
```

Read in LDSC rg tables
```{r}
ldsc_rg_info <- read_tsv(snakemake@input$full) %>%
    mutate(dataset=str_match(p1, 'pgc_mdd_([:alpha:]+)_')[,2])
    
ldsc_rg_mr_candidates <- read_tsv(snakemake@input$mr)
```

Plot size of genetic correlation versus covariance intercept

```{r ldsc_rg_gcov}
ggplot(ldsc_rg_info %>% filter(dataset=='full'), aes(x=abs(rg), y=gcov_int)) +
geom_point()
```

Compare genetic covariance for `full` versus `noUKBB` sumstats

```{r ldsc_noukbb_gcov_point}

ldsc_full_vs_noukbb_gcov <-
ldsc_rg_info %>%
select(id, trait, dataset, gcov_int) %>%
pivot_wider(names_from=dataset, values_from=gcov_int) %>%
mutate(ukb=str_detect(id, 'ukb'))

ggplot(ldsc_full_vs_noukbb_gcov, aes(x=full, y=noUKBB, colour=ukb)) +
geom_point() + 
facet_grid(~ukb) +
coord_equal()

```

```{r ldsc_noukbb_gcov_hist}

ldsc_full_noukbb_gcov <-
ldsc_rg_info %>%
filter(dataset %in% c('full', 'noUKBB')) %>%
mutate(ukb=if_else(str_detect(id, 'ukb'), 'sumstats from UKBB', 'other sumstats'))

ggplot(ldsc_full_noukbb_gcov, aes(x=gcov_int, fill=dataset)) +
geom_density() +
facet_grid(dataset~ukb)

ldsc_full_noukbb_gcov %>%
group_by(dataset, ukb) %>%
summarize(max_gov=max(abs(gcov_int)))

```

Plot rg for known subcategories
```{r rg_subcats}

ggplot(ldsc_rg_info %>% filter(!is.na(subcategory), dataset %in% 'full'),
aes(x=trait, y=rg, ymin=rg+se*qnorm(0.025), ymax=rg+se*qnorm(0.975))) +
geom_pointrange() +
coord_flip()

```

Compare new and previous results

```{r rg_previous}

ldsc_rg_full_howard <-
ldsc_rg_info %>%
filter(dataset %in% c('full', 'howard')) %>%
select(dataset, rg, se, p, gcov_int, id, trait, subcategory) %>%
pivot_wider(id_cols=c(subcategory, id, trait),
            names_from=dataset,
            values_from=c(rg, se, p, gcov_int))
			
ggplot(filter(ldsc_rg_full_howard, se_full <= 0.5),
	aes(x=rg_full,
	    y=rg_howard, ymin=rg_howard-se_howard, ymax=rg_howard+se_howard)) +
geom_segment(aes(y=rg_howard, yend=rg_howard, x=rg_full-se_full, xend=rg_full+se_full), alpha=0.1) +
geom_pointrange(alpha=0.1) 

```

Results that were `NA` with the previous sumstats
```{r}
ldsc_rg_full_howard %>%
filter(!is.na(p_full), is.na(p_howard))
```

Traits that were not significantly correlated before, after FDR correction

```{r rg_previous_fdr}

ldsc_rg_full_howard_fdr <-
ldsc_rg_full_howard %>%
filter(!is.na(p_full), !is.na(p_howard)) %>%
mutate(q_full=fdrtool::fdrtool(p_full, statistic='p', plot=FALSE)$qval,
       q_howard=fdrtool::fdrtool(p_howard, statistic='p', plot=FALSE)$qval)

ldsc_rg_full_howard_fdr %>%
filter(p_full <= 0.05, q_full <= 0.05, q_howard > 0.05) %>%
select(trait, rg_full, p_full, q_full) %>%
arrange(desc(abs(rg_full))) %>%
print(n=Inf)

```

Non-UKB/overlapping phenotypes sorted by magnitude of genetic correlation

```{r rg_full}

ldsc_rg_full_howard_fdr %>%
    filter(!str_detect(id, 'ukb'), p_full <= 0.05, q_full <= 0.05, abs(gcov_int_full) <= 0.05) %>%
    group_by(subcategory, word(str_to_lower(trait), 1)) %>%
    filter(p_full == min(p_full)) %>% 
    filter(rg_full == max(rg_full)) %>%
    arrange(subcategory, desc(abs(rg_full))) %>%
    group_by(subcategory) %>%
    slice(1:6) %>%
    select(trait, rg=rg_full, se=se_full, FDR=q_full, id) %>%
    print(n=Inf)

```