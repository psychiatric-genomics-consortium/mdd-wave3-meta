---
title: "PGC MDD3 sumstats QC checks for meta-analysis"
---

```{r}
library(dplyr)
library(readr)
library(tidyr)
library(stringr)
library(ggplot2)
```

# Reference panel alignment

Marker names were aligned to the meta-analysis reference panel and effect sizes were checked. SNPs with MAF < `r snakemake@params$maf` in the imputation reference panel and INFO < `r snakemake@params$info` in the cohort were removed.

```{r meta_qc_align}
meta_qc_align <- read_tsv(snakemake@input$meta_qc_align)
meta_qc_align %>% print(n=Inf)
```

Median odds-ratios with standard error
```{r meta_qc_align_mean_OR}

ggplot(meta_qc_align %>%
       unite('cohort',
	          cohort, ancestries, release, 
			  sep="."),
	    aes(x=reorder(cohort, mean_SE),
		    y=median_or,
			ymax=exp(log(median_or)+mean_SE),
		    ymin=exp(log(median_or)-mean_SE))) +
geom_linerange() +
geom_point() +
coord_flip(ylim=c(0.8, 1.25))

```

# Genetic correlation with clinical cohorts

LDSC genetic correlations were calculated with the PGC `MDD29` clinical cohorts

```{r meta_qc_ldsc}
meta_qc_ldsc <-
read_table2(snakemake@input$meta_qc_ldsc) %>%
mutate(se.mdd2=as.numeric(str_remove_all(se.mdd2, "[\\(\\)]")),
 se.mdd29=as.numeric(str_remove_all(se.mdd29, "[\\(\\)]")))
```
```{r metq_qc_ldsc_rg}
ggplot(meta_qc_ldsc, aes(x=reorder(paste(cohort, release), rg.mdd29), y=rg.mdd29, ymin=rg.mdd29-se.mdd29, ymax=rg.mdd29+se.mdd29)) +
geom_linerange() +
geom_point() +
coord_flip(ylim=c(0, 1.25))
```

# Genetic covariance intercepts

Pairwise LDSC genetic covariance intercepts between all cohorts

```{r meta_qc_ldsc_pairs}
meta_qc_ldsc_pairs <- read_tsv(snakemake@input$meta_qc_ldsc_pairs)

# calculate total sample sizes
meta_qc_samplesize <- meta_qc_align %>%
transmute(cohort, ancestries, release, N=N_cases+N_controls)

# sumstats appearing in MDD3 (exclude other
# sumstats like Wray 2018 that have had their 
# sumstats munged for other reasons)
meta_qc_ldsc_pairs_mdd3 <- meta_qc_ldsc_pairs  %>%
filter(subcohort1 != 'wray2018' & subcohort2 != 'wray2018') %>%
left_join(meta_qc_samplesize %>% rename(cohortN1=N), by=c('cohort1'='cohort', 'subcohort1'='release', 'ancestry1'='ancestries')) %>%
left_join(meta_qc_samplesize %>% rename(cohortN2=N), by=c('cohort2'='cohort', 'subcohort2'='release', 'ancestry2'='ancestries'))

ggplot(meta_qc_ldsc_pairs_mdd3, aes(x=gcov_int)) +
geom_histogram()
```

Show the largest and smallest intercepts. Exclude Wray2018 sumstats that are also in the mix. Calculate distance from 0 in standard deviation units to get an idea of the magnitude of departure from expectation relative to the other intercepts.

```{r meta_qc_ldsc_pairs_largest}
meta_qc_ldsc_pairs_mdd3 %>%
select(cohort1, subcohort1, cohort2, subcohort2, gcov_int) %>%
mutate(SDs=abs(gcov_int)/sd(gcov_int, na.rm=T)) %>%
arrange(desc(gcov_int))
```

```{r meta_qc_ldsc_pairs_smallest}
meta_qc_ldsc_pairs_mdd3 %>%
select(cohort1, subcohort1, cohort2, subcohort2, gcov_int) %>%
mutate(SDs=abs(gcov_int)/sd(gcov_int, na.rm=T)) %>%
arrange(gcov_int)
```

Estimate amount of sample overlap as $N_S = g_\mathrm{cov_{int}}\sqrt{N_1N_2} / r_\mathrm{P}$, where $r_\mathrm{P}$ is the phenotypic correlation between the two MDD phenotype (assume $r_\mathrm{P} = 1$)

```{r meta_qc_ldsc_pairs_ns}
rP <- 1
meta_qc_ldsc_pairs_mdd3_ns <-
meta_qc_ldsc_pairs_mdd3 %>%
mutate(Ns=gcov_int*sqrt(cohortN1*cohortN2)/rP) %>%
select(cohort1, subcohort1, cohort2, subcohort2, cohortN1, cohortN2, Ns) %>%
mutate(Ns_pct=100*Ns/(cohortN1+cohortN2))
```

Sort (largest-to-smallest) by sample overlap
```{r meta_qc_ldsc_pairs_nspct_arrange}
meta_qc_ldsc_pairs_mdd3_ns %>%
arrange(desc(Ns))
```

Sort (largest-to-smallest) by percentage of overlap to combined sample size
```{r meta_qc_ldsc_pairs_ns_arrange}
meta_qc_ldsc_pairs_mdd3_ns %>%
arrange(desc(Ns_pct))
```

Test for heterogeniety in covariance intercepts. Calculate $w$, the inverse variance of each $g_\mathrm{covint}$ standard error, then calculate a weighted sum $\hat{g_\mathrm{covint}}$

```{r meta_qc_ldsc_pairs_q}

meta_qc_ldsc_pairs_mdd3 %>%
filter(!is.na(gcov_int)) %>%
mutate(w=1/gcov_int_se^2) %>%
mutate(gcov_int_hat=sum(w*gcov_int)/sum(w)) %>%
summarise(Q=sum(w*(gcov_int-gcov_int_hat)^2), k=n()) %>%
mutate(I2=(Q-(k-1))/Q)

```

There is thus some heterogeneity in genetic covariance intercepts. We also want to look at heterogeniety per-cohort. The LDSC intercepts were calculated for each unique pair of cohorts. Expand this table to have every ordering of each pair

```{r}

# get unique cohort names from name and ancestry columns
meta_qc_ldsc_pairs_mdd3_named <-
meta_qc_ldsc_pairs_mdd3 %>%
mutate(cohort1=paste(cohort1, subcohort1, ancestry1, sep='.'),
	   cohort2=paste(cohort2, subcohort2, ancestry2, sep='.')) %>%
mutate(pair_name=paste(cohort1, cohort2, sep=','))

# get all unique cohort names
cohorts <- unique(c(meta_qc_ldsc_pairs_mdd3_named$cohort1,
                    meta_qc_ldsc_pairs_mdd3_named$cohort2))

# ordered pairs of cohort we have data listings for
cohorts_pair_names <- unique(meta_qc_ldsc_pairs_mdd3_named$pair_name)

# create list of all pairs of cohorts
meta_qc_ldsc_pairs_mdd3_all <-
tibble(cohort1=cohorts, cohort2=cohorts) %>%
complete(cohort1, cohort2) %>%
filter(cohort1 != cohort2) %>%
mutate(pair_name12=paste(cohort1, cohort2, sep=','),
	   pair_name21=paste(cohort2, cohort1, sep=',')) %>%
mutate(pair_name=case_when(pair_name12 %in% cohorts_pair_names ~ pair_name12,
                           pair_name21 %in% cohorts_pair_names ~ pair_name21,
						   TRUE ~ NA_character_)) %>%
select(cohort1, cohort2, pair_name) %>%
left_join(meta_qc_ldsc_pairs_mdd3_named %>% select(pair_name, gcov_int, gcov_int_se), by='pair_name')


```

Calculate $Q$ and $I^2$ for each cohort

```{r}
meta_qc_ldsc_pairs_mdd3_all_het <-
meta_qc_ldsc_pairs_mdd3_all %>%
group_by(cohort1) %>%
filter(!is.na(gcov_int)) %>%
mutate(w=1/gcov_int_se^2) %>%
mutate(gcov_int_hat=sum(w*gcov_int)/sum(w)) %>%
summarise(Q=sum(w*(gcov_int-gcov_int_hat)^2), k=n()) %>%
mutate(I2=(Q-(k-1))/Q) %>%
arrange(desc(I2))
meta_qc_ldsc_pairs_mdd3_all_het %>%
as.data.frame()
```

```{r plot_cohort_gcov_int}

# find range to fit all gcov_int values
gcov_int_min <- min(with(meta_qc_ldsc_pairs_mdd3, gcov_int-gcov_int_se), na.rm=TRUE)
gcov_int_max <- max(with(meta_qc_ldsc_pairs_mdd3, gcov_int+gcov_int_se), na.rm=TRUE)

ggplot(meta_qc_ldsc_pairs_mdd3_all %>% filter(cohort1 %in% meta_qc_ldsc_pairs_mdd3_all_het$cohort1[1:4]),
       aes(x=cohort2, y=gcov_int, ymin=gcov_int-gcov_int_se, ymax=gcov_int+gcov_int_se)) +
geom_point() +
geom_linerange() +
facet_grid(cols=vars(cohort1)) +
coord_flip(ylim=c(gcov_int_min-0.01, gcov_int_max+0.01))

```

```{r plot_cohort_gcov_int2}

ggplot(meta_qc_ldsc_pairs_mdd3_all %>% filter(cohort1 %in% meta_qc_ldsc_pairs_mdd3_all_het$cohort1[5:8]),
   aes(x=cohort2, y=gcov_int, ymin=gcov_int-gcov_int_se, ymax=gcov_int+gcov_int_se)) +
geom_point() +
geom_linerange() +
facet_grid(cols=vars(cohort1)) +
coord_flip(ylim=c(gcov_int_min-0.01, gcov_int_max+0.01))

```


